<template>
  <div>
    <div class="app flex-row align-items-center">
      <div class="container">
        <b-row class="justify-content-center">
          <b-col cols="12" sm="12" md="10">
            <b-card-group>
              <b-card
                no-body
                class="d-flex align-items-center justify-content-center p-4"
                style="max-width:100%"
              >
                <svg
                  width="100%"
                  height="400"
                  viewBox="0 0 314 417"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path d="M256.129 9.85129H0V389.16H256.129V9.85129Z" fill="#535461" />
                  <path
                    d="M186.328 398.975L0 389.16V9.85124L186.328 0.0365601V398.975Z"
                    fill="#17B6D3"
                  />
                  <path
                    d="M170.753 220.001C172.027 220.001 173.06 218.967 173.06 217.692C173.06 216.416 172.027 215.382 170.753 215.382C169.479 215.382 168.445 216.416 168.445 217.692C168.445 218.967 169.479 220.001 170.753 220.001Z"
                    fill="#535461"
                  />
                  <path
                    d="M170.753 218.036L172.353 220.809L173.952 223.581H170.753H167.554L169.153 220.809L170.753 218.036Z"
                    fill="#535461"
                  />
                  <path
                    d="M194.404 398.974L182.992 398.938L183.444 0.036377H194.404V398.974Z"
                    fill="#17B6D3"
                  />
                  <g opacity="0.1">
                    <path
                      opacity="0.1"
                      d="M194.53 398.938H182.992L183.569 0H194.53V398.938Z"
                      fill="white"
                    />
                  </g>
                  <path
                    opacity="0.1"
                    d="M170.753 208.454C174.895 208.454 178.252 205.094 178.252 200.949C178.252 196.804 174.895 193.444 170.753 193.444C166.611 193.444 163.254 196.804 163.254 200.949C163.254 205.094 166.611 208.454 170.753 208.454Z"
                    fill="black"
                  />
                  <path
                    d="M170.753 207.3C174.895 207.3 178.252 203.939 178.252 199.794C178.252 195.649 174.895 192.289 170.753 192.289C166.611 192.289 163.254 195.649 163.254 199.794C163.254 203.939 166.611 207.3 170.753 207.3Z"
                    fill="#535461"
                  />
                  <path
                    opacity="0.1"
                    d="M30.4698 9.29971V390.946"
                    stroke="black"
                    stroke-width="2"
                    stroke-miterlimit="10"
                  />
                  <path
                    opacity="0.1"
                    d="M63.3513 6.99036V392.1"
                    stroke="black"
                    stroke-width="2"
                    stroke-miterlimit="10"
                  />
                  <path
                    opacity="0.1"
                    d="M96.2328 5.25836V394.319"
                    stroke="black"
                    stroke-width="2"
                    stroke-miterlimit="10"
                  />
                  <path
                    opacity="0.1"
                    d="M129.114 3.52637V396.719"
                    stroke="black"
                    stroke-width="2"
                    stroke-miterlimit="10"
                  />
                  <path
                    opacity="0.1"
                    d="M161.996 1.79434V397.206"
                    stroke="black"
                    stroke-width="2"
                    stroke-miterlimit="10"
                  />
                  <path
                    d="M267.215 76.3948C279.8 76.3948 290.001 66.831 290.001 55.0335C290.001 43.2359 279.8 33.6721 267.215 33.6721C254.631 33.6721 244.429 43.2359 244.429 55.0335C244.429 66.831 254.631 76.3948 267.215 76.3948Z"
                    fill="#2F2E41"
                  />
                  <path
                    d="M200.875 188.109L195.107 196.192C195.107 196.192 167.417 201.965 177.801 210.625C188.184 219.285 203.183 202.542 203.183 202.542L211.259 192.15L200.875 188.109Z"
                    fill="#FFB8B8"
                  />
                  <path
                    d="M230.872 96.3129C230.872 96.3129 223.373 96.3129 221.643 106.705C219.912 117.097 218.181 151.737 218.181 151.737C218.181 151.737 193.953 183.49 197.991 187.532C202.029 191.573 206.644 199.078 209.528 197.924C212.413 196.769 237.218 162.706 237.218 162.706L230.872 96.3129Z"
                    fill="#17B6D3"
                  />
                  <path
                    opacity="0.1"
                    d="M230.872 96.3129C230.872 96.3129 223.373 96.3129 221.643 106.705C219.912 117.097 218.181 151.737 218.181 151.737C218.181 151.737 193.953 183.49 197.991 187.532C202.029 191.573 206.644 199.078 209.528 197.924C212.413 196.769 237.218 162.706 237.218 162.706L230.872 96.3129Z"
                    fill="black"
                  />
                  <path
                    d="M253.947 66.8688C253.947 66.8688 253.37 89.3849 246.448 90.5395C239.525 91.6942 241.833 99.1996 241.833 99.1996C241.833 99.1996 264.331 112.478 279.329 99.1996L282.214 92.2715C282.214 92.2715 271.83 84.7662 276.445 74.3742L253.947 66.8688Z"
                    fill="#FFB8B8"
                  />
                  <path
                    d="M215.297 205.429C215.297 205.429 181.262 268.936 193.953 288.565C206.644 308.195 225.681 348.608 228.565 348.608C231.449 348.608 247.602 340.525 246.448 335.329C245.294 330.133 227.988 291.452 223.373 287.988C218.758 284.524 221.066 275.287 221.643 274.709C222.219 274.132 241.256 243.533 241.256 243.533C241.256 243.533 240.679 292.029 242.987 299.535C245.294 307.04 242.41 360.732 245.294 363.041C248.179 365.351 261.446 369.392 263.754 365.928C266.061 362.464 272.984 309.927 268.369 297.803L277.022 214.666L215.297 205.429Z"
                    fill="#2F2E41"
                  />
                  <path
                    d="M246.448 359.577L232.026 386.135C232.026 386.135 211.259 401.145 225.681 403.455C240.102 405.764 248.755 399.991 248.755 399.991L261.446 390.753V364.196L246.448 359.577Z"
                    fill="#2F2E41"
                  />
                  <path
                    d="M226.834 344.567L234.334 362.464C234.334 362.464 237.218 369.969 234.334 371.701C231.449 373.433 223.373 383.825 228.565 384.98C229.609 385.185 230.671 385.29 231.735 385.295C236.058 385.368 240.352 384.565 244.356 382.934C248.361 381.303 251.995 378.878 255.039 375.804L259.716 371.124C259.716 371.124 243.696 334.204 243.918 334.478C244.14 334.752 226.834 344.567 226.834 344.567Z"
                    fill="#2F2E41"
                  />
                  <path
                    d="M268.369 80.7249C279.201 80.7249 287.982 71.9365 287.982 61.0955C287.982 50.2545 279.201 41.4661 268.369 41.4661C257.537 41.4661 248.755 50.2545 248.755 61.0955C248.755 71.9365 257.537 80.7249 268.369 80.7249Z"
                    fill="#FFB8B8"
                  />
                  <path
                    d="M279.618 88.5189L273.561 94.5809C273.561 94.5809 255.101 101.509 246.448 94.5809C246.448 94.5809 249.621 87.9415 249.621 88.5189C249.621 89.0962 224.527 92.8489 222.219 103.241C219.912 113.633 223.95 131.53 223.95 131.53C223.95 131.53 207.798 207.738 214.143 209.47C220.489 211.202 279.906 225.636 279.329 214.666C278.752 203.697 283.944 158.665 283.944 158.665L304.135 119.984C304.135 119.984 301.25 107.282 294.328 103.241C287.405 99.1995 279.618 88.5189 279.618 88.5189Z"
                    fill="#17B6D3"
                  />
                  <path
                    d="M253.947 201.388L246.448 206.006C246.448 206.006 217.604 225.636 232.603 229.1C247.602 232.564 256.255 215.244 256.255 215.244L262.023 208.316L253.947 201.388Z"
                    fill="#FFB8B8"
                  />
                  <path
                    opacity="0.1"
                    d="M296.635 116.52L301.827 121.716C301.827 121.716 305.288 170.212 298.366 180.026C291.444 189.841 259.716 216.398 257.985 214.666C256.255 212.934 245.294 204.274 247.602 203.12C249.909 201.965 280.589 169.883 280.589 169.883L278.176 125.18L296.635 116.52Z"
                    fill="black"
                  />
                  <path
                    d="M298.943 114.788L304.135 119.984C304.135 119.984 307.596 168.48 300.673 178.294C293.751 188.109 262.023 214.666 260.293 212.934C258.562 211.202 247.602 202.542 249.909 201.388C252.217 200.233 282.896 168.151 282.896 168.151L280.483 123.448L298.943 114.788Z"
                    fill="#17B6D3"
                  />
                  <path
                    d="M260.257 33.2132C260.257 33.2132 253.59 30.7868 244.498 35.9429L249.347 37.1561C249.347 37.1561 242.074 37.7627 241.165 47.4682H244.498C244.498 47.4682 242.377 55.9605 244.498 58.3869L245.862 55.8089L249.802 63.6946L250.711 59.7517L252.529 60.3583L253.742 53.9891C253.742 53.9891 256.772 58.5385 259.197 58.8418V54.899C259.197 54.899 265.864 62.4814 267.985 62.1781L264.955 57.9319L269.197 58.8418L267.379 55.8088L278.289 58.8418L275.864 55.8088L283.441 58.2352L287.077 59.7517C287.077 59.7517 292.229 47.9231 284.956 39.7341C277.683 31.5451 267.076 29.7253 260.257 33.2132Z"
                    fill="#2F2E41"
                  />
                </svg>
              </b-card>
              <b-card no-body class="p-4">
                <b-card-body class="d-flex justify-content-center flex-column align-item-center">
                  <b-form @submit.prevent="handlerSubmit">
                    <h3 class="text-center">{{ $t('login.title') }}</h3>
                    <b-input-group class="mb-3">
                      <b-input-group-prepend>
                        <b-input-group-text>
                          <i class="fa fa-user fa-lg"></i>
                        </b-input-group-text>
                      </b-input-group-prepend>
                      <b-form-input
                        type="text"
                        v-model="$v.form.username.$model"
                        :state="$v.form.username.$dirty ? !$v.form.username.$error : null"
                        class="form-control"
                        :placeholder="$t('login.username')"
                      />
                      <b-form-invalid-feedback
                        id="input-1-live-feedback"
                      >{{ $t('signup.errors.field') }}</b-form-invalid-feedback>
                    </b-input-group>

                    <b-input-group class="mb-4">
                      <b-input-group-prepend>
                        <b-input-group-text>
                          <i class="icon-lock"></i>
                        </b-input-group-text>
                      </b-input-group-prepend>
                      <b-form-input
                        type="password"
                        class="form-control"
                        v-model="$v.form.password.$model"
                        :state="$v.form.password.$dirty ? !$v.form.password.$error : null"
                        :placeholder="$t('login.password')"
                      />
                      <b-form-invalid-feedback
                        id="input-1-live-feedback"
                      >La contraseña debe tener al menos 6 caracteres.</b-form-invalid-feedback>
                    </b-input-group>
                    <b-row class="d-flex justify-content-center align-content-center">
                      <b-col sm="11" cols="6" md="5">
                        <b-button
                          type="submit"
                          :disabled="$v.form.$invalid"
                          variant="primary"
                          class="px-4"
                        >
                          {{$t('login.btn_singin')}}
                          <b-spinner v-show="getIsLoading" small type="grow"></b-spinner>
                        </b-button>
                      </b-col>
                      <!-- <b-col cols="6" class="text-right">
                      <b-button variant="link" class="px-0">Forgot password?</b-button>
                      </b-col>-->
                    </b-row>
                  </b-form>
                </b-card-body>
              </b-card>
            </b-card-group>
          </b-col>
        </b-row>
        <b-row class="pt-2">
          <b-col class="d-flex justify-content-end" md="11">
            <span>
              {{$t('login.signup.msg')}}
              <router-link to="/signup">{{ $t('login.signup.link') }}</router-link>
            </span>
          </b-col>
        </b-row>
      </div>
    </div>
  </div>
</template>

<script>
import { required, minLength, between, sameAs } from "vuelidate/lib/validators";
import { Action } from "@/store/const/user";
import { UIAction } from "@/store/const/ui";
import { isEmailAvailable } from "@/helpers/validators";
import axios from "axios";
import { createNamespacedHelpers } from "vuex";
import NavBar from "@/components/Nav";

const userModule = createNamespacedHelpers("user/");
const UIModule = createNamespacedHelpers("ui/");

export default {
  name: "Login",
  data() {
    return {
      form: {
        username: null,
        password: null
      }
    };
  },
  components: {
    NavBar
  },
  computed: {
    ...UIModule.mapGetters(["getIsLoading"]),
    ...userModule.mapGetters(["getToken"])
  },
  validations: {
    form: {
      username: {
        required
      },
      password: {
        required,
        minLength: minLength(6)
      }
    }
  },
  watch: {
    error_signup(oldValue, newValue) {
      if (newValue) {
        this.$bvToast.toast("Ocurrio un error al momento de registrarse", {
          title: "Error inesperado",
          autoHideDelay: 5000,
          appendToast: false,
          variant: "danger"
        });
      }
    }
  },
  mounted() {
    // this[UIAction.IS_LOADING]();
    if (this.$store.state.user.token != null) {
      this.$router.push("/recepcion");
    }
  },
  methods: {
    ...UIModule.mapActions([UIAction.ERROR_SIGNUP, UIAction.IS_LOADING]),
    ...userModule.mapActions([Action.USER_LOGIN]),
    async handlerSubmit() {
      this.$v.$touch();
      if (this.$v.$invalid) {
      } else {
        let opts = {
          headers: {
            "Content-Type": "application/json"
          }
        };

        let body = {
          username: this.form.username,
          password: this.form.password
        };

        this[UIAction.IS_LOADING]();
        try {
          if (this.getToken == null) {
            await this.USER_LOGIN({ body });
            this.$router.push("/recepcion");
          }
        } catch (error) {
          console.error(error);
        }
      }
    }
  }
};
</script>

<style scoped>
.form-control {
  background-color: #f0f3f5;
}
</style>
