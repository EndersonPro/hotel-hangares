<template>
  <div>
    <div class="app flex-row align-items-center">
      <div class="container">
        <b-row class="justify-content-center">
          <b-col cols="12" sm="12" md="10">
            <b-card-group>
              <b-card
                no-body
                class="d-flex align-items-center justify-content-center p-4"
                style="max-width:100%"
              >
                <svg
                  width="100%"
                  height="100%"
                  viewBox="0 0 314 417"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <g clip-path="url(#clip0)">
                    <path
                      d="M304.141 401.082H0.645752V13.1949C0.645752 13.1949 322.867 -16.4936 304.141 13.1949C285.414 42.8834 304.141 401.082 304.141 401.082Z"
                      fill="#F2F2F2"
                    />
                    <path
                      d="M304.786 401.727H0V12.5493H181.537V13.8401H1.29151V400.436H303.495V92.8589H304.786V401.727Z"
                      fill="#3F3D56"
                    />
                    <path
                      d="M222.34 113.612C213.912 113.613 204.845 111.881 196.604 106.679C172.697 91.586 149.751 106.517 149.523 106.67L149.449 106.712C149.236 106.816 135.065 113.611 118.377 113.612C109.949 113.613 100.882 111.881 92.6408 106.679C68.7339 91.586 45.7885 106.517 45.5596 106.67L44.8433 105.596C45.0797 105.439 68.7231 90.0545 93.3307 105.587C116.926 120.483 147.66 106.136 148.847 105.569C149.975 104.844 173.171 90.3608 197.294 105.587C221.25 120.71 252.531 105.707 252.844 105.553L253.412 106.712C253.199 106.816 239.028 113.611 222.34 113.612Z"
                      fill="#3F3D56"
                    />
                    <path
                      d="M222.34 144.592C213.912 144.592 204.845 142.86 196.604 137.658C172.697 122.566 149.751 137.496 149.523 137.649L149.449 137.692C149.236 137.796 135.065 144.59 118.377 144.592C109.949 144.592 100.882 142.86 92.6408 137.658C68.7339 122.566 45.7885 137.496 45.5596 137.649L44.8433 136.575C45.0797 136.418 68.7231 121.034 93.3307 136.566C116.926 151.462 147.66 137.116 148.847 136.548C149.975 135.823 173.171 121.34 197.294 136.566C221.25 151.689 252.531 136.686 252.844 136.533L253.412 137.692C253.199 137.796 239.028 144.59 222.34 144.592Z"
                      fill="#3F3D56"
                    />
                    <path
                      d="M222.34 175.571C213.912 175.572 204.845 173.84 196.604 168.637C172.697 153.544 149.751 168.475 149.523 168.628L149.449 168.671C149.236 168.775 135.065 175.57 118.377 175.571C109.949 175.572 100.882 173.84 92.6408 168.637C68.7339 153.544 45.7885 168.475 45.5596 168.628L44.8433 167.554C45.0797 167.397 68.7231 152.013 93.3307 167.546C116.926 182.442 147.66 168.095 148.847 167.528C149.975 166.803 173.171 152.319 197.294 167.546C221.25 182.668 252.531 167.666 252.844 167.512L253.412 168.671C253.199 168.775 239.028 175.57 222.34 175.571Z"
                      fill="#3F3D56"
                    />
                    <path
                      d="M124.463 206.601C124.203 206.601 123.942 206.593 123.679 206.577C119.453 206.315 115.704 203.915 112.537 199.444C109.398 195.013 106.061 192.789 102.544 192.833C96.6763 192.907 92.2744 199.365 92.2306 199.43L92.171 199.506C91.8888 199.815 85.1691 207.079 77.1863 206.577C72.9604 206.315 69.2111 203.915 66.044 199.444C62.9052 195.013 59.5396 192.789 56.0515 192.833C50.1834 192.907 45.7815 199.365 45.7377 199.43L44.665 198.711C44.8593 198.422 49.4961 191.624 56.0351 191.542C59.9949 191.473 63.6987 193.9 67.0977 198.698C70.0268 202.832 73.4463 205.05 77.2607 205.288C84.3752 205.726 90.7023 199.182 91.1882 198.667C91.6375 198.013 96.1888 191.622 102.528 191.542C102.568 191.541 102.608 191.541 102.647 191.541C106.545 191.541 110.226 193.948 113.591 198.698C116.52 202.832 119.939 205.05 123.754 205.288C131.127 205.754 137.645 198.706 137.71 198.635L138.664 199.506C138.391 199.805 132.092 206.6 124.463 206.601Z"
                      fill="#3F3D56"
                    />
                    <path
                      d="M182.743 329.442H122.044V288.136H168.537V289.427H123.335V328.151H181.451V308.789H182.743V329.442Z"
                      fill="#3F3D56"
                    />
                    <path
                      d="M38.0982 57.0823C36.5656 57.0823 35.0675 56.628 33.7932 55.777C32.5189 54.926 31.5257 53.7164 30.9392 52.3012C30.3527 50.8861 30.1993 49.3288 30.4983 47.8265C30.7972 46.3241 31.5352 44.9441 32.6189 43.861C33.7026 42.7779 35.0833 42.0402 36.5865 41.7414C38.0896 41.4426 39.6476 41.596 41.0635 42.1821C42.4794 42.7683 43.6896 43.761 44.5411 45.0346C45.3925 46.3083 45.847 47.8056 45.847 49.3374C45.8446 51.3908 45.0275 53.3593 43.5748 54.8112C42.1221 56.2632 40.1526 57.0799 38.0982 57.0823ZM38.0982 42.8834C36.821 42.8834 35.5726 43.2619 34.5107 43.9711C33.4488 44.6803 32.6211 45.6883 32.1324 46.8676C31.6436 48.0469 31.5158 49.3446 31.7649 50.5965C32.0141 51.8485 32.6291 52.9985 33.5321 53.9011C34.4352 54.8037 35.5858 55.4184 36.8384 55.6674C38.091 55.9165 39.3894 55.7887 40.5693 55.3002C41.7492 54.8117 42.7577 53.9845 43.4673 52.9231C44.1768 51.8617 44.5555 50.6139 44.5555 49.3374C44.5536 47.6263 43.8727 45.9858 42.6621 44.7759C41.4515 43.5659 39.8102 42.8853 38.0982 42.8834Z"
                      fill="#17B6D3"
                    />
                    <path
                      d="M168.246 315.371L152.884 294.168L157.068 291.14L168.827 307.37L213.824 261.165L217.526 264.766L168.246 315.371Z"
                      fill="#17B6D3"
                    />
                    <path
                      d="M225.684 147.116C225.684 147.116 233.433 167.123 219.227 167.123C205.02 167.123 241.182 187.131 255.388 175.514C269.594 163.896 261.199 163.251 261.199 163.251C261.199 163.251 242.473 165.187 243.119 148.407L225.684 147.116Z"
                      fill="#A0616A"
                    />
                    <path
                      d="M234.414 153.392C248.315 153.392 259.585 142.128 259.585 128.233C259.585 114.339 248.315 103.075 234.414 103.075C220.512 103.075 209.242 114.339 209.242 128.233C209.242 142.128 220.512 153.392 234.414 153.392Z"
                      fill="#2F2E41"
                    />
                    <path
                      d="M221.81 230.373L197.272 293.622C197.272 293.622 185.003 312.984 189.523 332.346C194.043 351.708 204.375 386.56 204.375 386.56C204.375 386.56 215.998 382.042 215.352 373.652C214.707 365.262 220.518 335.573 210.832 324.602L245.056 276.196L246.348 327.183C246.348 327.183 243.765 350.418 244.41 360.744C245.056 371.07 246.348 388.496 246.348 388.496L254.096 387.206C254.096 387.206 267.657 339.446 266.365 323.956C266.365 323.956 290.903 248.444 266.365 230.373L221.81 230.373Z"
                      fill="#2F2E41"
                    />
                    <path
                      d="M206.312 383.333C206.312 383.333 200.5 383.333 201.146 388.496C201.792 393.66 195.98 418.83 208.249 416.894C220.518 414.958 221.81 402.695 221.81 394.305C221.81 385.915 222.455 385.269 223.747 383.333C225.038 381.397 228.913 364.616 223.747 365.262C218.581 365.907 212.769 369.134 212.769 369.134C212.769 369.134 214.707 383.333 206.312 383.333Z"
                      fill="#2F2E41"
                    />
                    <path
                      d="M250.222 383.333C250.222 383.333 241.182 382.042 241.827 385.269C242.473 388.496 240.536 402.05 241.827 403.341C243.119 404.631 245.702 407.213 245.702 409.149C245.702 411.085 246.347 417.539 257.325 415.603C268.302 413.667 265.719 403.986 265.074 402.695C264.428 401.404 256.679 394.95 257.325 391.078C257.971 387.206 254.096 380.751 250.222 383.333Z"
                      fill="#2F2E41"
                    />
                    <path
                      d="M234.724 156.151C244.353 156.151 252.159 148.35 252.159 138.726C252.159 129.102 244.353 121.3 234.724 121.3C225.095 121.3 217.29 129.102 217.29 138.726C217.29 148.35 225.095 156.151 234.724 156.151Z"
                      fill="#A0616A"
                    />
                    <path
                      d="M251.191 161.637C251.191 161.637 256.769 172.669 239.798 172.861C234.467 172.921 229.383 168.343 226.007 164.219C224.815 162.763 224.312 165.752 222.133 165.51C216.321 164.864 200.5 165.833 200.5 176.159C200.5 186.485 218.581 225.855 217.29 229.727C215.998 233.6 209.541 232.954 217.29 235.536C225.038 238.118 240.536 231.664 250.868 236.827C261.199 241.99 270.885 229.082 270.885 229.082L286.383 173.577C286.383 173.577 262.814 159.056 251.191 161.637Z"
                      fill="#575A89"
                    />
                    <path
                      d="M206.312 265.87C206.312 265.87 190.169 278.778 197.272 283.296C204.375 287.814 212.769 265.87 212.769 265.87H206.312Z"
                      fill="#A0616A"
                    />
                    <path
                      d="M268.302 219.401C268.302 219.401 246.993 227.791 254.096 232.309C261.199 236.827 268.302 224.564 268.302 224.564V219.401Z"
                      fill="#A0616A"
                    />
                    <path
                      d="M206.958 169.705C204.585 170.559 202.528 172.114 201.06 174.164C199.593 176.214 198.785 178.662 198.742 181.182L197.917 230.373C197.917 230.373 194.043 270.388 203.729 270.388C213.415 270.388 220.518 273.615 221.81 270.388C223.101 267.161 217.289 238.118 217.289 238.118L206.958 169.705Z"
                      fill="#575A89"
                    />
                    <path
                      d="M274.114 171.641L286.383 173.577C286.383 173.577 320.607 190.358 312.858 201.975C305.109 213.592 272.177 230.373 272.177 230.373C272.177 230.373 259.908 224.564 263.782 220.692C267.657 216.819 285.092 203.266 285.092 203.266L270.24 189.712L274.114 171.641Z"
                      fill="#575A89"
                    />
                    <path
                      d="M251.028 125.325L238.254 118.638L220.614 121.374L216.965 137.485L226.05 137.136L228.588 131.216V137.038L232.78 136.877L235.213 127.454L236.734 137.485L251.636 137.181L251.028 125.325Z"
                      fill="#2F2E41"
                    />
                    <path
                      d="M235.738 109.695C241.348 109.695 245.895 105.15 245.895 99.5437C245.895 93.9371 241.348 89.392 235.738 89.392C230.129 89.392 225.582 93.9371 225.582 99.5437C225.582 105.15 230.129 109.695 235.738 109.695Z"
                      fill="#2F2E41"
                    />
                    <path
                      d="M222.932 96.4541C222.932 94.0293 223.8 91.6846 225.38 89.8441C226.959 88.0036 229.145 86.7887 231.543 86.4192C230.096 86.1979 228.619 86.2918 227.211 86.6945C225.804 87.0971 224.501 87.7989 223.39 88.752C222.28 89.705 221.388 90.8867 220.777 92.2161C220.166 93.5454 219.85 94.9911 219.85 96.4541C219.85 97.9171 220.166 99.3627 220.777 100.692C221.388 102.022 222.28 103.203 223.39 104.156C224.501 105.109 225.804 105.811 227.211 106.214C228.619 106.616 230.096 106.71 231.543 106.489C229.145 106.119 226.959 104.905 225.38 103.064C223.8 101.224 222.932 98.8789 222.932 96.4541Z"
                      fill="#2F2E41"
                    />
                    <path
                      d="M37.9592 379.373C41.6215 392.904 54.1656 401.285 54.1656 401.285C54.1656 401.285 60.772 387.727 57.1098 374.195C53.4475 360.664 40.9033 352.284 40.9033 352.284C40.9033 352.284 34.2969 365.842 37.9592 379.373Z"
                      fill="#3F3D56"
                    />
                    <path
                      d="M43.3407 376.465C53.39 386.243 54.6175 401.273 54.6175 401.273C54.6175 401.273 39.5517 400.451 29.5024 390.674C19.453 380.896 18.2256 365.866 18.2256 365.866C18.2256 365.866 33.2913 366.688 43.3407 376.465Z"
                      fill="#17B6D3"
                    />
                  </g>
                  <defs>
                    <clipPath id="clip0">
                      <rect width="314" height="417" fill="white" />
                    </clipPath>
                  </defs>
                </svg>
              </b-card>
              <b-card no-body class="p-4">
                <b-card-body>
                  <b-form @submit.prevent="handlerSubmit">
                    <h3 class="text-center">{{ $t('signup.title') }}</h3>
                    <b-input-group class="mb-3">
                      <b-input-group-prepend>
                        <b-input-group-text>
                          <i class="fa fa-user fa-lg"></i>
                        </b-input-group-text>
                      </b-input-group-prepend>
                      <b-form-input
                        type="text"
                        v-model="$v.form.username.$model"
                        :state="$v.form.username.$dirty ? !$v.form.username.$error : null"
                        class="form-control"
                        :placeholder="$t('signup.username')"
                      />
                      <b-form-invalid-feedback id="input-1-live-feedback">{{ $t('signup.errors.field') }}</b-form-invalid-feedback>
                    </b-input-group>
                    <b-input-group class="mb-3">
                      <b-input-group-prepend>
                        <b-input-group-text>
                          <i class="fa fa-user fa-lg"></i>
                        </b-input-group-text>
                      </b-input-group-prepend>
                      <b-form-input
                        type="text"
                        v-model="$v.form.nombre.$model"
                        :state="$v.form.nombre.$dirty ? !$v.form.nombre.$error : null"
                        class="form-control"
                        :placeholder="$t('signup.name')"
                      />
                      <b-form-invalid-feedback id="input-1-live-feedback">{{ $t('signup.errors.field') }}</b-form-invalid-feedback>
                    </b-input-group>
                    <b-input-group class="mb-3">
                      <b-input-group-prepend>
                        <b-input-group-text>
                          <i class="fa fa-user fa-lg"></i>
                        </b-input-group-text>
                      </b-input-group-prepend>
                      <b-form-input
                        type="text"
                        v-model="$v.form.apellido.$model"
                        :state="$v.form.apellido.$dirty ? !$v.form.apellido.$error : null"
                        class="form-control"
                        :placeholder="$t('signup.lastname')"
                      />
                      <b-form-invalid-feedback id="input-1-live-feedback">{{ $t('signup.errors.field') }}</b-form-invalid-feedback>
                    </b-input-group>
                    <b-input-group class="mb-3">
                      <b-input-group-prepend>
                        <b-input-group-text>
                          <i class="fa fa-id-card fa-lg"></i>
                        </b-input-group-text>
                      </b-input-group-prepend>
                      <b-form-input
                        type="tel"
                        v-model="$v.form.cedula.$model"
                        class="form-control"
                        :state="$v.form.cedula.$dirty ? !$v.form.cedula.$error : null"
                        :placeholder="$t('signup.cc')"
                      />
                      <b-form-invalid-feedback id="input-1-live-feedback">{{ $t('signup.errors.field') }}</b-form-invalid-feedback>
                    </b-input-group>
                    <b-input-group class="mb-3">
                      <b-input-group-prepend>
                        <b-input-group-text>
                          <i class="fa fa-at fa-lg"></i>
                        </b-input-group-text>
                      </b-input-group-prepend>
                      <b-form-input
                        type="text"
                        v-model="$v.form.email.$model"
                        :state="$v.form.email.$dirty ? !$v.form.email.$error : null"
                        class="form-control"
                        :placeholder="$t('signup.email')"
                      />
                      <b-form-invalid-feedback id="input-1-live-feedback">{{ $t('signup.errors.field') }}</b-form-invalid-feedback>
                    </b-input-group>
                    <!-- <div class="error" v-if="!$v.form.email.required">Campo requerido</div> -->
                    <b-input-group class="mb-3">
                      <b-input-group-prepend>
                        <b-input-group-text>
                          <i class="fa fa-phone fa-lg"></i>
                        </b-input-group-text>
                      </b-input-group-prepend>
                      <b-form-input
                        type="tel"
                        v-model="$v.form.phone.$model"
                        class="form-control"
                        :state="$v.form.phone.$dirty ? !$v.form.phone.$error : null"
                        :placeholder="$t('signup.cel')"
                      />
                      <b-form-invalid-feedback id="input-1-live-feedback">{{ $t('signup.errors.field') }}</b-form-invalid-feedback>
                    </b-input-group>
                    <b-input-group class="mb-4">
                      <b-input-group-prepend>
                        <b-input-group-text>
                          <i class="icon-lock"></i>
                        </b-input-group-text>
                      </b-input-group-prepend>
                      <b-form-input
                        type="password"
                        class="form-control"
                        v-model="$v.form.password.$model"
                        :state="$v.form.password.$dirty ? !$v.form.password.$error : null"
                        :placeholder="$t('signup.password')"
                      />
                      <b-form-invalid-feedback
                        id="input-1-live-feedback"
                      >La contraseña debe tener al menos 6 caracteres.</b-form-invalid-feedback>
                    </b-input-group>
                    <b-input-group class="mb-4">
                      <b-input-group-prepend>
                        <b-input-group-text>
                          <i class="icon-lock"></i>
                        </b-input-group-text>
                      </b-input-group-prepend>
                      <b-form-input
                        type="password"
                        class="form-control"
                        v-model="$v.form.repeat_password.$model"
                        :state="$v.form.repeat_password.$dirty ? !$v.form.repeat_password.$error : null"
                        :placeholder="$t('signup.repeat_password')"
                      />
                      <b-form-invalid-feedback
                        id="input-1-live-feedback"
                      >Las contraseñas no coinciden.</b-form-invalid-feedback>
                    </b-input-group>
                    <b-row class="d-flex justify-content-center align-content-center">
                      <b-col sm="11" cols="6" md="5">
                        <b-button
                          type="submit"
                          :disabled="$v.form.$invalid"
                          variant="primary"
                          class="px-4"
                        >
                          {{$t('signup.btn_singup')}}
                          <b-spinner v-show="getIsLoading" small type="grow"></b-spinner>
                        </b-button>
                      </b-col>
                      <!-- <b-col cols="6" class="text-right">
                      <b-button variant="link" class="px-0">Forgot password?</b-button>
                      </b-col>-->
                    </b-row>
                  </b-form>
                </b-card-body>
              </b-card>
            </b-card-group>
          </b-col>
        </b-row>
        <b-row class="pt-2">
          <b-col class="d-flex justify-content-end" md="11">
            <span class="login-message">
              {{$t('signup.signin.msg')}}
              <router-link to="/login">{{ $t('signup.signin.link') }}</router-link>
            </span>
          </b-col>
        </b-row>
      </div>
    </div>
  </div>
</template>

<script>
import { required, minLength, between, sameAs } from "vuelidate/lib/validators";
import { Action } from "@/store/const/user";
import { UIAction } from "@/store/const/ui";
import { isEmailAvailable } from "@/helpers/validators";
import axios from "axios";
import { createNamespacedHelpers } from "vuex";
import NavBar from "@/components/Nav";

const userModule = createNamespacedHelpers("user/");
const UIModule = createNamespacedHelpers("ui/");

export default {
  name: "SignUp",
  data() {
    return {
      form: {
        username:null,
        nombre: null,
        apellido: null,
        cedula: null,
        email: null,
        password: null,
        repeat_password: null,
        phone: null
      }
    };
  },
  components: {
    NavBar
  },
  computed: {
    ...UIModule.mapGetters(["getIsLoading"])
  },
  validations: {
    form: {
      username:{
        required
      },
      nombre: {
        required
      },
      apellido:{
        required
      },
      cedula:{
        required
      },
      email: {
        required,
        isEmailAvailable
      },
      password: {
        required,
        minLength: minLength(6)
      },
      repeat_password: {
        sameAsPassword: sameAs("password")
      },
      phone: {
        required
      }
    }
  },
  watch: {
    error_signup(oldValue, newValue) {
      if (newValue) {
        this.$bvToast.toast("Ocurrio un error al momento de registrarse", {
          title: "Error inesperado",
          autoHideDelay: 5000,
          appendToast: false,
          variant: "danger"
        });
      }
    }
  },
  mounted() {
    // this[UIAction.IS_LOADING]();
    // console.log(UIModule);
  },
  methods: {
    ...UIModule.mapActions([UIAction.ERROR_SIGNUP, UIAction.IS_LOADING]),
    ...userModule.mapActions([Action.USER_SIGNUP]),
    async handlerSubmit() {
      this.$v.$touch();
      if (this.$v.$invalid) {
      } else {
        let opts = {
          headers: {
            "Content-Type": "application/json"
          }
        };

        let body = {
          first_name: this.form.nombre,
          last_name: this.form.apellido,
          cedula: this.form.cedula,
          phone: this.form.phone,
          password: this.form.password,
          email: this.form.email,
          username: this.form.username
        };

        this[UIAction.IS_LOADING]();

        try {
          let { data, status } = await axios.post(
            "http://localhost:8000/api/v1.0/users/",
            body,
            opts
          );
          // console.log(data);
          switch (status) {
            case 201:
              console.log("Entre con estatus 201");
              if(this.$store.state.user.token==null){
                this[Action.USER_SIGNUP]({ data, body });
              }
              break;
            default:
              console.log("Ocurrio un error");
              this[UIAction.ERROR_SIGNUP](true);
          }
        } catch (error) {
          console.error(error);
        }
      }
    }
  }
};
</script>

<style>
.form-control {
  background-color: #f0f3f5;
}
</style>